{% load custom_filters %}

{% if factors == None %}
  <!-- Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† ÙØ¹Ø§Ù„ÛŒØª -->
  <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addActivityModal">
      â• Ø§ÙØ²ÙˆØ¯Ù† ÙØ¹Ø§Ù„ÛŒØª
  </button>

  <!-- Ù„ÛŒØ³Øª ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ -->
  {% for log in logs %}
    <div class="mb-3">
      <h6 class="text-muted">{{ log.timestamp|to_jalali }}</h6>
      <p>{{ log.description }}</p>
      <hr>
    </div>
  {% empty %}
    <p class="text-muted">Ù‡ÛŒÚ† ÙØ¹Ø§Ù„ÛŒØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
  {% endfor %}

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† ÙØ¹Ø§Ù„ÛŒØª -->
  <div class="modal fade" id="addActivityModal" tabindex="-1" aria-labelledby="addActivityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="{% url 'add_buyer_activity' buyer_id %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="addActivityModalLabel">Ø§ÙØ²ÙˆØ¯Ù† ÙØ¹Ø§Ù„ÛŒØª Ø¬Ø¯ÛŒØ¯</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="activity_type" class="form-label">Ù†ÙˆØ¹ ÙØ¹Ø§Ù„ÛŒØª</label>
              <select name="activity_type" class="form-select" required>
                {% for key in activity_choices %}
                  <option value="{{ key }}" {% if key == selected_activity_type %}selected{% endif %}>{{ key }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="description" class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
              <textarea id="description" name="description" class="form-control" rows="4" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
            <button type="submit" class="btn btn-primary">Ø«Ø¨Øª</button>
          </div>
        </form>
      </div>
    </div>
  </div>

{% else %}



  <h4 class="fw-bold text-primary mb-4">ğŸ“Š Ù†Ù…ÙˆØ¯Ø§Ø± Ø®Ø±ÛŒØ¯ Ù…ÙˆØ§Ø¯</h4>

  <!-- Pie Chart -->
  <canvas id="factorChart" width="400" height="300"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('factorChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: [{% for f in factors %}"{{ f.coop.material.name|default:"Ù†Ø§Ù…Ø´Ø®Øµ" }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
          label: 'Ù…Ù‚Ø¯Ø§Ø± Ø®Ø±ÛŒØ¯',
          data: [{% for f in factors %}{{ f.unit_price }}{% if not forloop.last %}, {% endif %}{% endfor %}],
          backgroundColor: [
            '#007bff', '#28a745', '#ffc107', '#dc3545', '#6610f2', '#17a2b8'
          ],
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: {
            display: true,
            text: 'Ù…Ù‚Ø¯Ø§Ø± Ø®Ø±ÛŒØ¯ Ù…ÙˆØ§Ø¯ ØªÙˆØ³Ø· Ù…Ø´ØªØ±ÛŒ'
          }
        }
      }
    });
  </script>

  <!-- List of Factors -->
  <h5 class="fw-bold mt-4">ğŸ“„ Ù„ÛŒØ³Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</h5>
  <ul class="list-group mb-4">
    {% for f in factors %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          {{ f.coop.material.name }} - {{ f.unit_price }} ØªÙˆÙ…Ø§Ù† - {{ f.discount }} ØªØ®ÙÛŒÙ
          <span class="badge bg-primary rounded-pill">{{ f.pre_invoice.created_at|to_jalali }}</span>
        </div>
        <a href="{% url 'show_factor' f.pre_invoice.id %}" class="btn btn-sm btn-outline-info">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ±</a>
      </li>

    {% endfor %}
  </ul>

  <!-- Total Price -->
  <h5 class="text-success fw-bold">ğŸ’° Ù…Ø¬Ù…ÙˆØ¹ Ø®Ø±ÛŒØ¯: 
    {{ total_price }} ØªÙˆÙ…Ø§Ù†
  </h5>

{% endif %}
